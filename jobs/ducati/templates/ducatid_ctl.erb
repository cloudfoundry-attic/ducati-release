#!/bin/bash

set -e -u

RUN_DIR=/var/vcap/sys/run/ducati
LOG_DIR=/var/vcap/sys/log/ducati
PIDFILE=$RUN_DIR/ducatid.pid

mkdir -p /var/vcap/sys/log/monit
exec 1>> /var/vcap/sys/log/monit/ducatid.out.log
exec 2>> /var/vcap/sys/log/monit/ducatid.err.log


case $1 in

  start)

    mkdir -p $RUN_DIR
    mkdir -p $LOG_DIR

    echo $$ > $PIDFILE


    dbHost="<%= p("ducati.daemon.database.host") %>"
    dbPort="<%= p("ducati.daemon.database.port") %>"
    dbUser="<%= p("ducati.daemon.database.username") %>"
    dbPass="<%= p("ducati.daemon.database.password") %>"
    dbName="<%= p("ducati.daemon.database.name") %>"
    dbSSLMode="<%= p("ducati.daemon.database.ssl_mode") %>"
    databaseURL="postgres://$dbUser:$dbPass@$dbHost:$dbPort/$dbName?sslmode=$dbSSLMode"

    exec /var/vcap/packages/ducati/bin/ducatid \
      -listenAddr=<%= p("ducati.daemon.listen_address") %> \
      -overlayNetwork=<%= p("ducati.daemon.overlay_network") %> \
      -localSubnet=<%= p("ducati.daemon.local_subnet").sub('${index}', "#{spec.index}") %> \
      -sandboxRepoDir=<%= p("ducati.daemon.sandbox_dir") %> \
      -databaseURL="$databaseURL" \
      1>>$LOG_DIR/ducatid.stdout.log \
      2>>$LOG_DIR/ducatid.stderr.log

    ;;

  stop)

    kill -INT $(cat $PIDFILE)

    ;;

  *)
    echo "Usage: $0 {start|stop}"

    ;;

esac
